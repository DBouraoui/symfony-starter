localhost:80 {
    # Document root vers le dossier public de Symfony
    root * /var/www/public

    # Activation des logs
    log {
        output file /var/log/caddy/access.log
        format single_field common_log
    }

    # Compression automatique
    encode gzip

    # Servir les fichiers statiques directement
    file_server

    # Proxy vers PHP-FPM pour les fichiers .php
    @php {
        path *.php
    }
    reverse_proxy @php app:9000 {
        transport fastcgi {
            split .php
        }
    }

    # Front controller pour Symfony (toutes les routes non-existantes vers index.php)
    @notFile {
        not file
        not path /favicon.ico
        not path /robots.txt
    }
    rewrite @notFile /index.php

    # Sécurité : bloquer l'accès aux fichiers sensibles
    @blocked {
        path /.env*
        path /composer.*
        path /var/*
        path /vendor/*
        path /config/*
        path /src/*
        path /tests/*
        path /.git*
        path /README*
        path /LICENSE*
        path /.docker*
        path /docker*
        path /Dockerfile*
    }
    respond @blocked 403

    # Headers de sécurité
    header {
        # Prévention XSS
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"

        # Cache pour les assets statiques
        @static {
            path *.css *.js *.png *.jpg *.jpeg *.gif *.svg *.ico *.woff *.woff2 *.ttf *.eot
        }
        Cache-Control @static "public, max-age=31536000"
    }
}